<!DOCTYPE html>
<html lang="en">
<head>
  <title>CAS Dashboard Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --card: #16213e;
      --border: rgba(255,255,255,0.08);
      --accent1: #7c3aed;
      --accent2: #06b6d4;
      --accent-grad: linear-gradient(135deg, #7c3aed, #06b6d4);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --user-bubble: linear-gradient(135deg, #7c3aed, #5b21b6);
      --bot-bubble: #1e293b;
      --input-bg: #0f172a;
      --shadow: 0 25px 60px rgba(0,0,0,0.5);
    }

    .light {
      --bg: #f0f4ff;
      --surface: #ffffff;
      --card: #ffffff;
      --border: rgba(0,0,0,0.08);
      --accent1: #7c3aed;
      --accent2: #0891b2;
      --text: #1e293b;
      --text-muted: #64748b;
      --user-bubble: linear-gradient(135deg, #7c3aed, #5b21b6);
      --bot-bubble: #e8edf8;
      --input-bg: #f1f5f9;
      --shadow: 0 25px 60px rgba(100,100,200,0.15);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      transition: background 0.4s ease;
      padding: 20px;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(124,58,237,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(6,182,212,0.12) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* ‚îÄ‚îÄ Chatbox ‚îÄ‚îÄ */
    #chatbox {
      width: 420px;
      max-width: 100%;
      border-radius: 28px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: var(--surface);
      border: 1px solid var(--border);
      position: relative;
      z-index: 1;
      animation: floatIn 0.6s cubic-bezier(0.34,1.56,0.64,1) both;
    }

    @keyframes floatIn {
      from { opacity: 0; transform: translateY(40px) scale(0.95); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    #chat-header {
      background: var(--accent-grad);
      padding: 22px 20px 18px;
      position: relative;
      overflow: hidden;
    }

    #chat-header::after {
      content: '';
      position: absolute;
      bottom: -20px; right: -20px;
      width: 120px; height: 120px;
      border-radius: 50%;
      background: rgba(255,255,255,0.06);
    }

    #chat-header::before {
      content: '';
      position: absolute;
      top: -30px; left: 60%;
      width: 80px; height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.05);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .avatar-wrap {
      width: 52px; height: 52px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
      display: flex; align-items: center; justify-content: center;
      font-size: 26px;
      position: relative;
    }

    .status-dot {
      position: absolute;
      bottom: 2px; right: 2px;
      width: 12px; height: 12px;
      background: #22c55e;
      border-radius: 50%;
      border: 2px solid white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.7; }
    }

    .header-info h3 {
      font-family: 'Sora', sans-serif;
      font-size: 17px;
      font-weight: 700;
      color: white;
      letter-spacing: 0.3px;
    }

    .header-info p {
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      margin-top: 2px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, transform 0.2s;
    }

    .icon-btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.1); }

    /* ‚îÄ‚îÄ Chat Messages ‚îÄ‚îÄ */
    #chat-messages {
      height: 300px;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: var(--card);
      scroll-behavior: smooth;
    }

    #chat-messages::-webkit-scrollbar { width: 4px; }
    #chat-messages::-webkit-scrollbar-track { background: transparent; }
    #chat-messages::-webkit-scrollbar-thumb { background: var(--accent1); border-radius: 10px; }

    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      animation: msgIn 0.35s cubic-bezier(0.34,1.56,0.64,1) both;
    }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(16px) scale(0.95); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .msg-row.user { flex-direction: row-reverse; }

    .msg-avatar {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      border: 2px solid var(--border);
    }

    .msg-avatar.bot-av { background: var(--accent-grad); }
    .msg-avatar.user-av { background: rgba(124,58,237,0.2); }

    .bubble {
      max-width: 75%;
      padding: 11px 15px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.55;
      position: relative;
    }

    .bubble.bot {
      background: var(--bot-bubble);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .bubble.user {
      background: var(--user-bubble);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .bubble-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
      text-align: right;
    }

    .msg-row.bot-row .bubble-time { text-align: left; }

    /* Typing indicator */
    .typing-bubble {
      background: var(--bot-bubble);
      padding: 14px 18px;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .typing-bubble span {
      width: 7px; height: 7px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }

    .typing-bubble span:nth-child(2) { animation-delay: 0.2s; }
    .typing-bubble span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    /* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ */
    #input-area {
      padding: 14px 16px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mic-btn {
      width: 42px; height: 42px;
      border-radius: 50%;
      border: 1.5px solid var(--border);
      background: var(--input-bg);
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .mic-btn:hover { border-color: var(--accent1); color: var(--accent1); }
    .mic-btn.listening { background: rgba(239,68,68,0.15); border-color: #ef4444; color: #ef4444; animation: micPulse 1s infinite; }

    @keyframes micPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
    }

    #question {
      flex: 1;
      padding: 11px 16px;
      border-radius: 22px;
      border: 1.5px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      font-family: 'DM Sans', sans-serif;
      outline: none;
      transition: border 0.2s;
    }

    #question::placeholder { color: var(--text-muted); }
    #question:focus { border-color: var(--accent1); }

    #ask-btn {
      width: 42px; height: 42px;
      border-radius: 50%;
      border: none;
      background: var(--accent-grad);
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: transform 0.2s, opacity 0.2s;
      box-shadow: 0 4px 15px rgba(124,58,237,0.4);
    }

    #ask-btn:hover { transform: scale(1.1); opacity: 0.9; }
    #ask-btn:active { transform: scale(0.95); }

    /* ‚îÄ‚îÄ Clear btn ‚îÄ‚îÄ */
    #clear-btn {
      display: block;
      width: calc(100% - 32px);
      margin: 0 16px 14px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }

    #clear-btn:hover { background: rgba(239,68,68,0.1); color: #ef4444; border-color: rgba(239,68,68,0.3); }
  </style>
</head>
<body>

<div id="chatbox">

  <!-- Header -->
  <div id="chat-header">
    <div class="header-top">
      <div class="header-left">
        <div class="avatar-wrap">
          ü§ñ
          <div class="status-dot"></div>
        </div>
        <div class="header-info">
          <h3>CAS Assistant</h3>
          <p>Always here to help you</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="toggleDark()" title="Toggle Dark/Light">üåô</button>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div id="chat-messages">
    <!-- Welcome message -->
    <div class="msg-row bot-row">
      <div class="msg-avatar bot-av">ü§ñ</div>
      <div>
        <div class="bubble bot">üëã Hi! I'm your CAS Assistant. Ask me anything about the dashboard!</div>
        <div class="bubble-time">Just now</div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div id="input-area">
    <button class="mic-btn" id="mic-btn" onclick="toggleVoice()" title="Voice Input">üé§</button>
    <input type="text" id="question" placeholder="Ask something..." onkeydown="if(event.key==='Enter') ask()">
    <button id="ask-btn" onclick="ask()" title="Send">‚û§</button>
  </div>

  <button id="clear-btn" onclick="clearChat()">üóëÔ∏è Clear Chat History</button>

</div>

<script>
const SHEET_ID = "15nVPABd1lsP507CQeBDyJRrm2qDeiBPE1PeVu_x255s";
const API_KEY = "AIzaSyA9hwrryLxGH9OMSCcnGUNaaxAIfn9t_yE";

let isDark = true;
let isListening = false;
let recognition = null;

// ‚îÄ‚îÄ Dark/Light Toggle ‚îÄ‚îÄ
function toggleDark() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  document.querySelector('.icon-btn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
}

// ‚îÄ‚îÄ Get Time ‚îÄ‚îÄ
function getTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// ‚îÄ‚îÄ Add Message Bubble ‚îÄ‚îÄ
function addMessage(text, sender) {
  const messages = document.getElementById('chat-messages');
  const row = document.createElement('div');
  row.className = `msg-row ${sender === 'user' ? 'user' : 'bot-row'}`;

  const avatarDiv = `<div class="msg-avatar ${sender === 'user' ? 'user-av' : 'bot-av'}">${sender === 'user' ? 'üë§' : 'ü§ñ'}</div>`;
  const timeDiv = `<div class="bubble-time">${getTime()}</div>`;
  const bubbleDiv = `<div class="bubble ${sender}">${text}</div>`;

  if (sender === 'user') {
    row.innerHTML = `<div>${bubbleDiv}${timeDiv}</div>${avatarDiv}`;
  } else {
    row.innerHTML = `${avatarDiv}<div>${bubbleDiv}${timeDiv}</div>`;
  }

  messages.appendChild(row);
  messages.scrollTop = messages.scrollHeight;
}

// ‚îÄ‚îÄ Show Typing ‚îÄ‚îÄ
function showTyping() {
  const messages = document.getElementById('chat-messages');
  const row = document.createElement('div');
  row.className = 'msg-row bot-row';
  row.id = 'typing-indicator';
  row.innerHTML = `
    <div class="msg-avatar bot-av">ü§ñ</div>
    <div class="typing-bubble"><span></span><span></span><span></span></div>
  `;
  messages.appendChild(row);
  messages.scrollTop = messages.scrollHeight;
}

// ‚îÄ‚îÄ Remove Typing ‚îÄ‚îÄ
function removeTyping() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

// ‚îÄ‚îÄ Ask ‚îÄ‚îÄ
async function ask() {
  const input = document.getElementById('question');
  const userInput = input.value.trim();
  if (!userInput) return;

  addMessage(userInput, 'user');
  input.value = '';
  showTyping();

  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1?key=${API_KEY}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("API request failed");

    const data = await res.json();

    // Simulate typing delay for natural feel
    await new Promise(r => setTimeout(r, 1000 + Math.random() * 600));
    removeTyping();

    if (!data.values) {
      addMessage("‚ö†Ô∏è No data found in sheet.", 'bot');
      return;
    }

    const rows = data.values;
    let found = "‚ùå Sorry, I couldn't find an answer for that. Try rephrasing your question!";
    const lower = userInput.toLowerCase();

    for (let i = 1; i < rows.length; i++) {
      const question = rows[i][0]?.toLowerCase() || "";
      if (lower.includes(question) || question.includes(lower)) {
        found = rows[i][1] || "No answer available.";
        break;
      }
    }

    addMessage(found, 'bot');

  } catch (error) {
    removeTyping();
    addMessage("‚ö†Ô∏è Error fetching data. Please check your connection.", 'bot');
    console.error("Error:", error);
  }
}

// ‚îÄ‚îÄ Clear Chat ‚îÄ‚îÄ
function clearChat() {
  const messages = document.getElementById('chat-messages');
  messages.innerHTML = '';
  addMessage("üëã Chat cleared! How can I help you?", 'bot');
}

// ‚îÄ‚îÄ Voice Input ‚îÄ‚îÄ
function toggleVoice() {
  const micBtn = document.getElementById('mic-btn');

  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    addMessage("‚ö†Ô∏è Sorry, voice input is not supported in your browser. Try Chrome!", 'bot');
    return;
  }

  if (isListening) {
    recognition.stop();
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = false;

  recognition.onstart = () => {
    isListening = true;
    micBtn.classList.add('listening');
    micBtn.textContent = 'üî¥';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('question').value = transcript;
    ask();
  };

  recognition.onend = () => {
    isListening = false;
    micBtn.classList.remove('listening');
    micBtn.textContent = 'üé§';
  };

  recognition.onerror = () => {
    isListening = false;
    micBtn.classList.remove('listening');
    micBtn.textContent = 'üé§';
    addMessage("‚ö†Ô∏è Voice input failed. Please try again.", 'bot');
  };

  recognition.start();
}
</script>
</body>
</html>
